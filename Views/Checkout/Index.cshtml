@using Ecomerce.Models
@using Ecomerce.Services
@model Pedido

@{
    ViewData["Title"] = "Finalizar Compra";
    // 1. Injetar ICarrinhoServico diretamente na View para obter o desconto do cupom
    // Isso é necessário pois o desconto do cupom é armazenado na Session (via CarrinhoServico) e não no ViewBag.
    var carrinhoServico = Context.RequestServices.GetRequiredService<ICarrinhoServico>();
}
<div class="container mt-5">
    <div class="row g-4 align-items-stretch">

        <div class="col-lg-6 d-flex">
            <div class="card shadow-lg border-0 rounded-4 h-100 w-100">
                <div class="card-header bg-primary text-white text-center py-3 rounded-top-4">
                    <h4 class="mb-0"><i class="bi bi-truck me-2"></i> Dados para Entrega</h4>
                </div>

                <div class="card-body p-4">
                    <form asp-action="Index" method="post">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="mb-3">
                            <label asp-for="NomeCliente" class="form-label fw-semibold"></label>
                            <input asp-for="NomeCliente" class="form-control shadow-sm" placeholder="Seu nome completo" />
                            <span asp-validation-for="NomeCliente" class="text-danger small"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Endereco" class="form-label fw-semibold"></label>
                            <input asp-for="Endereco" class="form-control shadow-sm" placeholder="Rua, número, bairro" />
                            <span asp-validation-for="Endereco" class="text-danger small"></span>
                        </div>

                        <div class="mb-4">
                            <label asp-for="Cidade" class="form-label fw-semibold"></label>
                            <input asp-for="Cidade" class="form-control shadow-sm" placeholder="Cidade" />
                            <span asp-validation-for="Cidade" class="text-danger small"></span>
                        </div>

                        <button type="submit" class="btn btn-success w-100 py-2 fw-semibold">
                            <i class="bi bi-credit-card me-1"></i> Confirmar Envio e Prosseguir para Pagamento
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6 d-flex">
            <div class="card shadow-lg border-0 rounded-4 h-100 w-100">
                <div class="card-header bg-dark text-white text-center py-3 rounded-top-4">
                    <h4 class="mb-0"><i class="bi bi-cart-check me-2"></i> Resumo do Pedido</h4>
                </div>

                <div class="card-body p-4">

                    @{
                        List<ItemCarrinho> carrinhoItens = ViewBag.CarrinhoItens as List<ItemCarrinho>;
                        decimal totalFinal = ViewBag.TotalCarrinho ?? 0.00m;

                        decimal subtotalOriginal = 0.00m;
                        decimal economiaPromocaoProduto = 0.00m;
                        
                        decimal descontoCupom = carrinhoServico.GetDescontoCupom();
                        string codigoCupom = carrinhoServico.GetCodigoCupom();
                        
                        decimal economiaTotal = descontoCupom;
                    }

                    <table class="table align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Produto</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (carrinhoItens != null)
                            {
                                @foreach (ItemCarrinho item in carrinhoItens)
                                {
                                    decimal precoTabela = item.PrecoTabela;
                                    decimal precoPromocional = item.PrecoPromocional ?? 0.00m;
                                    
                                    decimal precoFinal = precoPromocional > 0 && precoPromocional < precoTabela 
                                                        ? precoPromocional 
                                                        : precoTabela;
                                    
                                    bool temPromocao = precoFinal < precoTabela;

                                    subtotalOriginal += precoTabela * item.Quantidade;
                                    economiaPromocaoProduto += (precoTabela - precoFinal) * item.Quantidade;
                                    
                                    <tr>
                                        <td>
                                            <strong>@item.Quantidade x @(item.Produto?.Nome ?? "Produto Indisponível")</strong>
                                            @if (temPromocao)
                                            {
                                                <span class="badge bg-danger ms-2">Promo</span>
                                            }
                                        </td>
                                        <td class="text-end">@((precoFinal * item.Quantidade).ToString("C2"))</td>
                                    </tr>
                                }
                                economiaTotal += economiaPromocaoProduto;
                            }
                        </tbody>
                        <tfoot>
                            <tr class="table-light">
                                <td class="fw-bold text-end">Subtotal (Preço Tabela):</td>
                                <td class="fw-bold text-end">@subtotalOriginal.ToString("C2")</td>
                            </tr>
                            
                            @if (descontoCupom > 0)
                            {
                                <tr class="table-info">
                                    <td class="fw-bold text-end text-primary">Desconto Cupom (@codigoCupom):</td>
                                    <td class="fw-bold text-end text-primary">- @descontoCupom.ToString("C2")</td>
                                </tr>
                            }
                            
                            @if (economiaPromocaoProduto > 0)
                            {
                                <tr class="table-success">
                                    <td class="fw-bold text-end text-success">Economia de Promoções:</td>
                                    <td class="fw-bold text-end text-success">- @economiaPromocaoProduto.ToString("C2")</td>
                                </tr>
                            }
                            
                            @if (economiaTotal > 0)
                            {
                                <tr class="table-danger">
                                    <td class="fw-bold text-end text-danger">Economia Total:</td>
                                    <td class="fw-bold text-end text-danger">- @economiaTotal.ToString("C2")</td>
                                </tr>
                            }
                            
                            <tr class="table-dark text-white">
                                <td class="fw-bold text-end">Total a pagar:</td>
                                <td class="fw-bold text-end">@totalFinal.ToString("C2")</td>
                            </tr>
                        </tfoot>
                    </table>

                    <a asp-action="Index" asp-controller="Carrinho" class="btn btn-outline-secondary w-100 mt-3">
                        <i class="bi bi-arrow-left me-1"></i> Voltar e Editar Carrinho
                    </a>

                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
}